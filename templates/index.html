<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Taxi Kalkylator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding: 20px; max-width: 700px; margin: auto; }
    button { padding: 10px; margin-top: 10px; font-size: 16px; cursor:pointer; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .map-preview { width: 100%; height: 300px; border: 1px solid #ccc; margin-top: 20px; }
    .result-box { background: #f0f0f0; padding: 10px; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    input, select { width: 100%; padding: 10px; font-size: 16px; }
    .location-row { display: flex; gap: 0; margin: 10px 0; }
    .location-row input { flex: 1; height: 40px; padding: 10px; border-radius: 4px 0 0 4px; border: 1px solid #ccc; border-right: none; }
    .location-row button { height: 40px; padding: 0 14px; font-size: 18px; border-radius: 0 4px 4px 0; border: 1px solid #ccc; background: #f3f3f3; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places" defer></script>
</head>
<body>
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h2>üöñ Taxi Kalkylator</h2>
    <a href="/settings" style="text-decoration:none;font-size:16px;background:#007BFF;color:#fff;padding:8px 12px;border-radius:4px;">‚öôÔ∏è Inst√§llningar</a>
  </div>

  <form method="POST" id="taxi-form">
    <!-- Fastpris-dropdowns -->
    <div class="row">
      <select id="pre_from" name="pre_from">
        <option value="">üìç Fr√•n (fastpris)</option>
      </select>


      <select id="pre_to" name="pre_to" disabled>
        <option value="">Till (fastpris)</option>
      </select>
    </div>

    <!-- Passagerare -->
    <div style="width: 200px; margin-top: 10px;">
      <select name="passengers" id="passengers" style="width:100%;padding:6px;">
        <option value="0">Antal passagerare</option>
        {% for i in range(1, 61) %}
          <option value="{{ i }}" {% if i == passengers %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Fr√•n/Till med place_id -->
    <div class="location-row">
      <input type="text" id="origin" name="origin" placeholder="Fr√•n" class="autocomplete" value="{{ origin }}" />
      <input type="hidden" id="origin_place_id" name="origin_place_id" />
      <button type="button" onclick="useCurrentLocation()">üìç</button>
    </div>
    <input type="text" id="destination" name="destination" placeholder="Till" class="autocomplete" value="{{ destination }}" />
    <input type="hidden" id="destination_place_id" name="destination_place_id" />

    <!-- flagga f√∂r fastpris -->
    <input type="hidden" name="fixed_price" id="fixed_price" value="0" />

    <button type="submit">Ber√§kna</button>
  </form>

  {% if result %}
    <iframe src="{{ result.map_url }}" class="map-preview" allowfullscreen></iframe>
    <div class="result-box">
      <strong>Fr√•n:</strong> {{ result.origin }}<br>
      <strong>Till:</strong> {{ result.destination }}<br>
      <strong>Avst√•nd:</strong> {{ result.distance }} km<br>
      <strong>Restid:</strong> {{ result.duration }}<br>
      <table>
        <tr><th>Typ</th><th>Pris</th></tr>
        {% for item in result.calculations %}
          <tr><td>{{ item.tariff }}</td><td><strong>{{ item.total_cost }} kr</strong></td></tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}

  <script>
    const predefined = {{ predefined_routes|tojson|safe }};
    const preFromSelect = document.getElementById("pre_from");
    const preToSelect = document.getElementById("pre_to");
    const originInput = document.getElementById("origin");
    const destInput = document.getElementById("destination");
    const fixedInput = document.getElementById("fixed_price");
    const originPID = document.getElementById("origin_place_id");
    const destPID = document.getElementById("destination_place_id");

    function unique(arr){ return [...new Set(arr)]; }

    // Fyll "Fr√•n" med unika origin-titlar
    function populateFromList() {
      const origins = unique(predefined.map(r => r.from));
      origins.sort().forEach(o => {
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o;
        preFromSelect.appendChild(opt);
      });
    }

    // Fyll "Till" baserat p√• vald "Fr√•n"
    preFromSelect.addEventListener("change", () => {
      const from = preFromSelect.value;
      preToSelect.innerHTML = '<option value="">Till (fastpris)</option>';
      preToSelect.disabled = true;
      if (!from) return;
      const dests = [...new Set(predefined.filter(r => r.from === from).map(r => r.to))];
      dests.forEach(to => {
        const opt = document.createElement("option");
        opt.value = to; opt.textContent = to;
        preToSelect.appendChild(opt);
      });
      preToSelect.disabled = false;
    });

    // N√§r man v√§ljer fastpris: fyll och skicka
    preToSelect.addEventListener("change", () => {
      const from = preFromSelect.value;
      const to = preToSelect.value;
      if (!from || !to) return;
      originInput.value = from;
      destInput.value = to;
      fixedInput.value = 1;
      // fastpris anv√§nder sparade adresser ‚Üí rensa place_id (s√• backend tar rutternas adresser)
      originPID.value = ""; destPID.value = "";
      document.getElementById("taxi-form").submit();
    });

    // Autocomplete + place_id
    function initAutocomplete() {
      document.querySelectorAll(".autocomplete").forEach(input => {
        const ac = new google.maps.places.Autocomplete(input, {
                      fields: ["place_id", "formatted_address", "geometry"],
                      types: ["geocode"],
                      componentRestrictions: { country: ['se', 'no'] }   // <‚Äî svensk/norsk bias
                    });
        ac.addListener("place_changed", () => {
          const place = ac.getPlace();
          if (input.id === "origin") {
            originPID.value = place.place_id || "";
            if (place.formatted_address) input.value = place.formatted_address;
          } else if (input.id === "destination") {
            destPID.value = place.place_id || "";
            if (place.formatted_address) input.value = place.formatted_address;
          }
        });
        input.addEventListener("input", () => {
          // om anv√§ndaren b√∂rjar skriva igen, nolla place_id s√• backend inte anv√§nder gammal id
          if (input.id === "origin") originPID.value = "";
          if (input.id === "destination") destPID.value = "";
        });
      });
    }

    function useCurrentLocation() {
      if (!navigator.geolocation) return alert("Din enhet st√∂der inte plats");
      navigator.geolocation.getCurrentPosition(pos => {
        const coords = `${pos.coords.latitude},${pos.coords.longitude}`;
        originInput.value = coords;
        originPID.value = ""; // vi skickar lat,lng
      });
    }

    window.onload = () => {
  if (typeof google === "object") initAutocomplete();
  populateFromList(); // <‚Äî NYTT: fyll unika 'Fr√•n'
};

  </script>
</body>
</html>
