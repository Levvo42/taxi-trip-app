<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taxi Kalkylator</title>

  <!-- V√•r egen CSS (ligger i /static/styles.css) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <!-- Google Maps JS (Places + Geocoder) -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places" defer></script>
</head>
<body>
  <!-- Huvudcontainer: centrerar och s√§tter maxbredd -->
  <main class="container">

    <!-- Topp-rad: rubrik + knapp till inst√§llningar -->
    <div class="brand" style="justify-content:space-between; align-items:center;">
      <div>üöñ Taxi Kalkylator</div>
      <a href="/settings" class="btn btn-primary" style="text-decoration:none;">‚öôÔ∏è</a>
    </div>

    <!-- ===================== FORMUL√ÑR ===================== -->
    <!-- OBS: vi √§ndrar inte id/name ‚Äì din JS forts√§tter fungera -->
    <form method="POST" id="taxi-form">
      <div class="card grid form-grid">

        <!-- Fastpris-dropdowns -->
        <div class="field" style="grid-column: span 6;">
          <label>Fr√•n (fastpris)</label>
          <select id="pre_from" name="pre_from">
            <option value="">üìç Fr√•n (fastpris)</option>
          </select>
        </div>

        <div class="field" style="grid-column: span 6;">
          <label>Till (fastpris)</label>
          <select id="pre_to" name="pre_to" disabled>
            <option value="">Till (fastpris)</option>
          </select>
        </div>

        <!-- Passagerare -->
        <div class="field" style="grid-column: span 3;">
          <label>Passagerare</label>
          <input
            type="number"
            name="passengers"
            id="passengers"
            min="0"
            step="1"
            inputmode="numeric"
            placeholder="Antal passagerare"
            value="{{ passengers|default(0) }}"
          >
        </div>
        <div class="field" style="grid-column: span 9;"></div>

        <!-- Fr√•n/Till med place_id -->
        <div class="field" style="grid-column: span 6;">
          <label>Fr√•n (adress eller plats)</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="origin" name="origin" placeholder="Fr√•n" class="autocomplete" value="{{ origin }}">
            <input type="hidden" id="origin_place_id" name="origin_place_id">
            <!-- üìç: s√§tt nuvarande plats som start (vi reverse-geokodar s√• det blir en adress) -->
            <button type="button" class="btn btn-outline" id="use-current-btn">üìç</button>
          </div>
        </div>

        <div class="field" style="grid-column: span 6;">
          <label>Till (adress eller plats)</label>
          <input type="text" id="destination" name="destination" placeholder="Till" class="autocomplete" value="{{ destination }}">
          <input type="hidden" id="destination_place_id" name="destination_place_id">
        </div>

        <!-- flagga f√∂r fastpris (0 = tariff, 1 = fastpris) -->
        <input type="hidden" name="fixed_price" id="fixed_price" value="0">

        <!-- Ber√§kna -->
        <div class="field" style="grid-column: span 12;">
          <button type="submit" class="btn btn-primary">Ber√§kna</button>
        </div>

      </div>
    </form>

    <!-- ===================== RESULTAT ===================== -->
    {% if result %}
      <div class="card" style="margin-top:16px;">

        <!-- KARTA (ENDA kartan ‚Äì tidigare hade du tv√• iframes) -->
        <iframe src="{{ result.map_url }}" class="map-preview" allowfullscreen></iframe>

        <!-- √ñppna i Google Maps -->
        <div class="actions">
          {% if gmaps_url %}
            <a class="btn btn-outline" href="{{ gmaps_url }}" target="_blank" rel="noopener">
              √ñppna i Google Maps
            </a>
          {% endif %}
        </div>

        <!-- Res-meta (fr√•n/till/avst√•nd/tid) -->
        <div class="result-meta">
          <div><b>Fr√•n:</b> {{ result.origin }}</div>
          <div><b>Till:</b> {{ result.destination }}</div>
          <div><b>Avst√•nd:</b> {{ result.distance }} km</div>
          <div><b>Restid:</b> {{ result.duration }}</div>
        </div>

        <!-- Pris-tabell -->
        <table class="table">
          <thead>
            <tr><th>Typ</th><th>Pris</th></tr>
          </thead>
          <tbody>
            {% for item in result.calculations %}
              <tr>
                <td>{{ item.tariff }}</td>
                <td>{{ item.total_cost }} kr</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    <!-- ===================== DATA + SCRIPT ===================== -->

    <!-- F√∂rdefinierade rutter (vi l√§gger JSON i ett data-attribut s√• JS-parsning alltid funkar) -->
    <div id="predefined-data"
         data-json='{{ predefined_routes | default([]) | tojson }}'
         hidden></div>

    <script>
      // ---------- H√§mta element ----------
      const predefined  = JSON.parse(document.getElementById('predefined-data').dataset.json || '[]');
      const form        = document.getElementById("taxi-form");
      const preFrom     = document.getElementById("pre_from");
      const preTo       = document.getElementById("pre_to");
      const originInput = document.getElementById("origin");
      const destInput   = document.getElementById("destination");
      const fixedInput  = document.getElementById("fixed_price");
      const originPID   = document.getElementById("origin_place_id");
      const destPID     = document.getElementById("destination_place_id");
      const useCurrent  = document.getElementById("use-current-btn");

      // ---------- Hj√§lp: unika v√§rden ----------
      const unique = arr => [...new Set(arr)];

      // ---------- Fyll "Fr√•n (fastpris)" ----------
      function populateFromList() {
        const origins = unique(predefined.map(r => r.from)).sort();
        origins.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o; opt.textContent = o;
          preFrom.appendChild(opt);
        });
      }

      // N√§r "Fr√•n (fastpris)" √§ndras ‚Üí fyll "Till (fastpris)"
      preFrom.addEventListener("change", () => {
        const from = preFrom.value;
        preTo.innerHTML = '<option value="">Till (fastpris)</option>';
        preTo.disabled = !from;
        if (!from) return;
        const dests = unique(predefined.filter(r => r.from === from).map(r => r.to));
        dests.forEach(to => {
          const opt = document.createElement("option");
          opt.value = to; opt.textContent = to;
          preTo.appendChild(opt);
        });
      });

      // N√§r "Till (fastpris)" v√§ljs ‚Üí s√§tt origin/destination + flagga och POST:a
      preTo.addEventListener("change", () => {
        const from = preFrom.value;
        const to = preTo.value;
        if (!from || !to) return;
        originInput.value = from;
        destInput.value   = to;
        fixedInput.value  = 1;     // fastpris
        originPID.value   = "";    // anv√§nd sparade adresser i backend
        destPID.value     = "";
        form.submit();
      });

      // ---------- Places Autocomplete + place_id ----------
      function initAutocomplete() {
        document.querySelectorAll(".autocomplete").forEach(input => {
          const ac = new google.maps.places.Autocomplete(input, {
            fields: ["place_id", "formatted_address", "geometry"],
            types: ["geocode"],
            componentRestrictions: { country: ['se', 'no'] }
          });
          ac.addListener("place_changed", () => {
            const place = ac.getPlace();
            if (input.id === "origin") {
              originPID.value = place.place_id || "";
              if (place.formatted_address) input.value = place.formatted_address;
            } else if (input.id === "destination") {
              destPID.value = place.place_id || "";
              if (place.formatted_address) input.value = place.formatted_address;
            }
          });
          // Om anv√§ndaren b√∂rjar skriva igen ‚Üí nolla place_id (vi vill inte ha ett gammalt id)
          input.addEventListener("input", () => {
            if (input.id === "origin")      originPID.value = "";
            if (input.id === "destination") destPID.value   = "";
          });
        });
      }

      // ---------- üìç Nuvarande plats ----------
      // G√∂r tv√• saker:
      // 1) H√§mtar lat,lng via geolocation
      // 2) Reverse-geokodar till en snygg adress i f√§ltet (om det funkar),
      //    annars fall-back till "lat,lng" text.
      function useCurrentLocation() {
        if (!navigator.geolocation) {
          alert("Din enhet st√∂der inte plats");
          return;
        }
        navigator.geolocation.getCurrentPosition(async pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const coords = `${lat},${lng}`;

          // F√∂rs√∂k geokoda till en adress (Maps JS har Geocoder inbyggt)
          if (window.google && google.maps && google.maps.Geocoder) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: { lat, lng } }, (results, status) => {
              if (status === "OK" && results && results[0]) {
                originInput.value = results[0].formatted_address; // snygg adress i f√§ltet
              } else {
                originInput.value = coords; // fallback
              }
              originPID.value = ""; // backend f√•r lat,lng eller adress ‚Äì b√•da funkar
            });
          } else {
            // Om JS-API inte laddats av n√•gon anledning
            originInput.value = coords;
            originPID.value = "";
          }
        }, err => {
          console.warn("Geolocation fel:", err);
          alert("Kunde inte h√§mta din position.");
        });
      }

      // Koppla knappen till funktionen
      useCurrent.addEventListener("click", useCurrentLocation);

      // ---------- Init p√• sidladdning ----------
      window.addEventListener("load", () => {
        if (typeof google === "object" && google.maps) initAutocomplete();
        populateFromList();
      });
    </script>
  </main>
</body>
</html>
