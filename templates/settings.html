<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Inst√§llningar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #ffffff;
      --fg: #222;
      --muted: #666;
      --brand: #0d6efd;
      --ok: #198754;
      --warn: #fd7e14;
      --err: #dc3545;
      --card: #f7f7f9;
      --border: #ddd;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 1000px; margin: 0 auto; padding: 20px;
      background: var(--bg); color: var(--fg);
    }
    h1, h2, h3 { margin: 18px 0 12px; }
    .grid { display: grid; gap: 16px; }
    .cols-2 { grid-template-columns: 1fr 1fr; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      padding: 16px; border-radius: 8px;
    }
    label { font-size: 14px; color: var(--muted); display: block; margin: 6px 0 4px; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px;
      background: #fff;
    }
    button {
      display: inline-block; padding: 10px 14px; border: 1px solid var(--brand);
      background: var(--brand); color: #fff; border-radius: 6px; font-size: 15px; cursor: pointer;
    }
    button.secondary { background: transparent; color: var(--brand); }
    button.full { width: 100%; }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    .price-entry {
      background: #f0f4ff; border: 1px solid #d8e3ff; border-left: 4px solid var(--brand);
      padding: 12px; border-radius: 6px; margin: 10px 0;
    }
    .muted { color: var(--muted); font-size: 13px; }
    .flash { padding: 10px 12px; border-radius: 6px; margin: 10px 0; border: 1px solid transparent; }
    .flash.success { background: #e9f7ef; border-color: #bde5c8; color: #13653f; }
    .flash.warning { background: #fff4e6; border-color: #ffd6a2; color: #7a4d0b; }
    .flash.danger  { background: #fdecea; border-color: #f5c6cb; color: #842029; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; }
    th { background: #fafafa; }
    .section-title { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    form.inline { display:inline; }
  </style>

  <!-- Google Places med callback n√§r allt √§r laddat -->
  <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initPlaces" async defer></script>

  <script>
    // Initiera Autocomplete p√• alla .autocomplete i ett givet root
    function initAutocompleteScope(root = document) {
      const mapNameToHidden = {
        'place_address': 'place_place_id',
        'route_from_address': 'route_from_place_id',
        'route_to_address': 'route_to_place_id'
      };

      const inputs = root.querySelectorAll('.autocomplete');
      inputs.forEach(input => {
        try {
          const ac = new google.maps.places.Autocomplete(input, {
            fields: ['place_id','formatted_address','geometry'],
            types: ['geocode'],
            componentRestrictions: { country: ['se','no'] }
          });

          ac.addListener('place_changed', () => {
            const place = ac.getPlace() || {};
            if (place.formatted_address) input.value = place.formatted_address;

            const hidId = mapNameToHidden[input.name];
            if (hidId) {
              const hid = document.getElementById(hidId);
              if (hid) hid.value = place.place_id || '';
            }
          });

          // Om man b√∂rjar skriva igen ‚Äì nolla place_id
          input.addEventListener('input', () => {
            const hidId = mapNameToHidden[input.name];
            if (hidId) {
              const hid = document.getElementById(hidId);
              if (hid) hid.value = '';
            }
          });
        } catch (e) {
          console.warn('Autocomplete init failed for', input.name, e);
        }
      });
    }

    // Called av Google-scriptets &callback n√§r libbet √§r redo
    function initPlaces() {
      initAutocompleteScope(document);
    }

    // L√§gg till ny priskategori-rad i "L√§gg till rutt"-formul√§ret
    function addPriceRow(ev) {
      ev.preventDefault();
      const wrap = document.getElementById('price-rows');
      const div = document.createElement('div');
      div.className = 'price-entry';
      div.innerHTML = `
        <label>Etikett</label>
        <input type="text" name="price_label[]" placeholder="t.ex. 1‚Äì4 personer" />
        <div class="row">
          <div>
            <label>Min</label>
            <input type="number" name="price_min[]" step="1" min="0" />
          </div>
          <div>
            <label>Max (valfritt)</label>
            <input type="number" name="price_max[]" step="1" min="0" />
          </div>
          <div>
            <label>Total (kr)</label>
            <input type="number" name="price_total[]" step="1" min="0" />
          </div>
          <div>
            <label>Pris/Person (kr)</label>
            <input type="number" name="price_ppp[]" step="1" min="0" />
          </div>
        </div>`;
      wrap.appendChild(div);
    }
  </script>
</head>
<body>

  <h1>‚öôÔ∏è Inst√§llningar</h1>

  <!-- Flash-meddelanden -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="grid cols-2">
    <!-- V√§nster: Tariffer + Platser -->
    <div class="grid">
      <!-- Tariffer (lokalt) -->
      <div class="card">
        <div class="section-title">
          <h2>Tariffer</h2>
          <span class="muted">Sparas lokalt i settings.json</span>
        </div>
        <form method="POST">
          <input type="hidden" name="action" value="save_tariffs" />
          {% for name, values in tariffs.items() %}
            <div class="card" style="padding:12px; background:#fff; border-color:#eee;">
              <h3 style="margin:0 0 8px;">{{ name }}</h3>
              <div class="row">
                <div>
                  <label>Startkostnad</label>
                  <input type="number" name="{{ name }}_start" value="{{ values.start }}" step="0.01" />
                </div>
                <div>
                  <label>Pris per km</label>
                  <input type="number" name="{{ name }}_km" value="{{ values.km }}" step="0.01" />
                </div>
                <div>
                  <label>Pris per timme</label>
                  <input type="number" name="{{ name }}_hour" value="{{ values.hour }}" step="0.01" />
                </div>
              </div>
            </div>
          {% endfor %}
          <div style="margin-top:10px;">
            <button type="submit" class="full">üíæ Spara tariffer</button>
          </div>
        </form>
      </div>

      <!-- L√§gg till plats (Sheets) -->
      <div class="card">
        <div class="section-title">
          <h2>üìç L√§gg till plats</h2>
          <span class="muted">Sparas i Google Sheets</span>
        </div>
        <form method="POST">
          <input type="hidden" name="action" value="add_place" />
          <label>Titel</label>
          <input type="text" name="place_title" placeholder="t.ex. √Öre" required />
          <label>Adress (Google Maps)</label>
          <input type="text" name="place_address" class="autocomplete" placeholder="Skriv adress" required />
          <input type="hidden" id="place_place_id" name="place_place_id" />
          <label>Alias (valfritt, kommateckenseparerat)</label>
          <input type="text" name="place_aliases" placeholder="t.ex. √Öre centrum, √Öre by" />
          <div style="margin-top:10px;">
            <button type="submit" class="full">üíæ Spara plats till Sheets</button>
          </div>
          <p class="muted" style="margin-top:8px;">Platsen geokodas (SE/NO) och sparas med place_id + lat/lng.</p>
        </form>
      </div>
    </div>

    <!-- H√∂ger: L√§gg till rutt + √ñversikter -->
    <div class="grid">
      <!-- L√§gg till fastprisrutt (Sheets) -->
      <div class="card">
        <div class="section-title">
          <h2>üõ£Ô∏è L√§gg till fastprisrutt</h2>
          <span class="muted">Sparas i Google Sheets</span>
        </div>
        <form method="POST">
          <input type="hidden" name="action" value="add_route" />
          <div class="row">
            <div>
              <label>Fr√•n (titel)</label>
              <select name="route_from_title" required>
                <option value="">V√§lj...</option>
                {% for p in address_titles %}
                  <option value="{{ p.title }}">{{ p.title }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>Till (titel)</label>
              <select name="route_to_title" required>
                <option value="">V√§lj...</option>
                {% for p in address_titles %}
                  <option value="{{ p.title }}">{{ p.title }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Fr√•n-adress (valfritt ‚Äì h√§mtas fr√•n plats om tomt)</label>
              <input type="text" name="route_from_address" class="autocomplete" placeholder="Skriv adress" />
              <input type="hidden" id="route_from_place_id" name="route_from_place_id" />
            </div>
            <div>
              <label>Till-adress (valfritt ‚Äì h√§mtas fr√•n plats om tomt)</label>
              <input type="text" name="route_to_address" class="autocomplete" placeholder="Skriv adress" />
              <input type="hidden" id="route_to_place_id" name="route_to_place_id" />
            </div>
          </div>

          <label>Ruttitel (valfritt)</label>
          <input type="text" name="route_title" placeholder="t.ex. √Öre ‚Üí V√¶rnes Flygplats" />

          <label style="margin-top:6px;">
            <input type="checkbox" name="route_create_reverse" checked />
            Skapa returv√§g ocks√•
          </label>

          <h3 style="margin-top:14px;">Priskategorier</h3>
          <p class="muted" style="margin:6px 0 10px;">
            Fyll minst en rad. <strong>Exakt en</strong> av <em>Total</em> eller <em>Pris/Person</em> ska vara ifylld.
          </p>

          <div id="price-rows">
            <div class="price-entry">
              <label>Etikett</label>
              <input type="text" name="price_label[]" placeholder="t.ex. 1‚Äì4 personer" />
              <div class="row">
                <div>
                  <label>Min</label>
                  <input type="number" name="price_min[]" step="1" min="0" />
                </div>
                <div>
                  <label>Max (valfritt)</label>
                  <input type="number" name="price_max[]" step="1" min="0" />
                </div>
                <div>
                  <label>Total (kr)</label>
                  <input type="number" name="price_total[]" step="1" min="0" />
                </div>
                <div>
                  <label>Pris/Person (kr)</label>
                  <input type="number" name="price_ppp[]" step="1" min="0" />
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <button class="secondary" style="border-color:#ccc;" onclick="addPriceRow(event)">‚ûï L√§gg till rad</button>
            <span></span>
          </div>

          <div style="margin-top:12px;">
            <button type="submit" class="full">üíæ Spara rutt + priser till Sheets</button>
          </div>
        </form>
      </div>

      <!-- √ñversikt: Platser -->
      <div class="card">
        <div class="section-title">
          <h2>üìç Platser (√∂versikt)</h2>
          <span class="muted">{{ address_titles|length }} st</span>
        </div>
        <div style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:6px;">
          <table>
            <thead>
              <tr><th style="width:32px;"></th><th>Titel</th><th>Adress</th></tr>
            </thead>
            <tbody>
              {% for p in address_titles %}
                <tr>
                  <td>
                    <form method="POST" class="inline" onsubmit="return confirm('Ta bort plats {{p.title}}?');">
                      <input type="hidden" name="action" value="delete_place">
                      <input type="hidden" name="place_id" value="{{ p.id }}">
                      <button type="submit" class="secondary" title="Ta bort" style="border-color:#ccc;">‚úñ</button>
                    </form>
                  </td>
                  <td>{{ p.title }}</td>
                  <td class="muted">{{ p.address }}</td>
                </tr>
              {% endfor %}
              {% if address_titles|length == 0 %}
                <tr><td colspan="3" class="muted">Inga platser √§nnu.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <p class="muted" style="margin-top:8px;">Obs: G√•r bara att ta bort platser som inte anv√§nds av rutter.</p>
      </div>

      <!-- √ñversikt: Rutter -->
      <div class="card">
        <div class="section-title">
          <h2>üõ£Ô∏è Rutter (√∂versikt)</h2>
          <span class="muted">{{ predefined|length }} st</span>
        </div>
        <div style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:6px;">
          <table>
            <thead>
              <tr>
                <th style="width:32px;"></th>
                <th>Fr√•n</th>
                <th>Till</th>
                <th>Priskategorier</th>
              </tr>
            </thead>
            <tbody>
              {% for r in predefined %}
                <tr>
                  <td>
                    <form method="POST" class="inline" onsubmit="return confirm('Ta bort rutt {{r.from}} ‚Üí {{r.to}}?');">
                      <input type="hidden" name="action" value="delete_route">
                      <input type="hidden" name="route_id" value="{{ r.route_id }}">
                      <button type="submit" class="secondary" title="Ta bort" style="border-color:#ccc;">‚úñ</button>
                    </form>
                  </td>
                  <td>{{ r.from }}</td>
                  <td>{{ r.to }}</td>
                  <td class="muted">{{ r.prices and r.prices|length or 0 }}</td>
                </tr>
              {% endfor %}
              {% if predefined|length == 0 %}
                <tr><td colspan="4" class="muted">Inga rutter √§nnu.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <p class="muted" style="margin-top:8px;">Tar √§ven bort kopplade priskategorier.</p>
      </div>
    </div>
  </div>

</body>
</html>
